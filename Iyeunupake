<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Terpadu PAI SD</title>

<style>
body{margin:0;padding:0;background:#eef5ff;font-family:Arial, sans-serif;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:10px;}
.container{width:100%;max-width:520px;background:white;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.15);padding-bottom:20px;}
header{background:#2E8B57;color:white;text-align:center;padding:15px;font-size:1.3rem;border-radius:12px 12px 0 0;font-weight:bold;}
.screen{display:none;padding:15px;}
.screen.active{display:block;}
input,select{width:100%;padding:10px;margin:6px 0 12px;border-radius:6px;border:1px solid #aaa;font-size:1rem;}
button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:6px;font-weight:bold;color:white;background:#2E8B57;}
button.blue{background:#3498db;}
button.red{background:#e74c3c;}
button.yellow{background:#f1c40f;color:black;}
.option{padding:10px;border:1px solid #aaa;border-radius:6px;margin-top:8px;cursor:pointer;}
.option.selected{background:#d4ffe1;border:2px solid #2E8B57;}
.musicBox{background:#fafafa;border:1px solid #ccc;padding:10px;border-radius:6px;margin-top:10px;}
.trackName{font-size:0.9rem;margin-bottom:6px;color:#333;}
.controls{display:flex;gap:6px;margin-top:6px;}
.controls button{flex:1;}
.scrollBox{max-height:350px;overflow-y:auto;border:1px solid #ccc;padding:10px;border-radius:6px;}
</style>
</head>
<body>
<div class="container">

<header>SISTEM TERPADU PAI SD</header>

<div id="login" class="screen active">
<input id="studentName" placeholder="Nama lengkap...">
<select id="studentClass">
<option value="">Pilih Kelas</option>
<option>3A</option><option>3B</option>
<option>4A</option><option>4B</option>
</select>
<button onclick="startQuiz()">Mulai Kuis</button>
<button class="blue" onclick="openGuruLogin()">Login Guru</button>
<button class="yellow" onclick="openKhodam()">Cek Khodam</button>

<div class="musicBox">
<b>ðŸŽ§ Musik Latar</b>
<div id="trackName" class="trackName">Memuat lagu...</div>
<div class="controls">
  <button id="btnStop" class="red">Stop</button>
  <button id="btnNext" class="yellow">Lanjut</button>
</div>
</div>

<div id="loginError" style="color:red;margin-top:6px;display:none;"></div>
</div>
<div id="quiz" class="screen">
  <h3 id="progress"></h3>
  <div id="questionText" style="font-size:1.1rem;margin-top:10px;"></div>
  <div id="options"></div>
  <button id="nextBtn" onclick="nextQuestion()" disabled>Selanjutnya</button>
  <div id="timerElem" style="text-align:center;margin-top:10px;color:#444;"></div>
</div>

<div id="result" class="screen">
  <h3>HASIL KUIS</h3>
  <p id="nameResult"></p>
  <h1 id="scoreBox"></h1>
  <button onclick="restart()">Kembali</button>
</div>

<div id="guruLogin" class="screen">
  <input id="guruPass" type="password" placeholder="Password Guru...">
  <button onclick="guruSubmit()">Masuk</button>
  <div id="guruError" style="color:red;margin-top:6px;display:none;"></div>
  <button class="blue" onclick="showScreen('login')">Kembali</button>
</div>

<div id="menuAdmin" class="screen">
  <h3 style="text-align:center;">MENU GURU</h3>
  <button onclick="openNama()">Input Nama</button>
  <button onclick="loadAbsensi()">Absensi</button>
  <button onclick="loadRekapAbsensi()">Rekap Absensi</button>
  <button onclick="loadRekapNilai()">Rekap Nilai</button>
  <button onclick="exportNilai()">Export Nilai</button>
  <button onclick="exportAbsensi()">Export Absensi</button>
  <button onclick="toggleRepeat()">Mode Ulang Kuis: <span id="repeatLabel"></span></button>
  <button class="red" onclick="resetSemua()">Reset Semua Data</button>
  <button onclick="logoutGuru()">Logout</button>
</div>

<div id="inputNama" class="screen">
  <input id="namaInput" placeholder="Nama lengkap...">
  <select id="kelasInput">
    <option value="">Pilih Kelas</option>
    <option>3A</option><option>3B</option>
    <option>4A</option><option>4B</option>
  </select>
  <button onclick="simpanNama()">Simpan</button>
  <button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
  <div id="listNamaBox" class="scrollBox" style="margin-top:10px;font-size:0.9rem;"></div>
</div>

<div id="absenScreen" class="screen">
  <h3 style="text-align:center;">ABSENSI â€” Hari <span id="hariSpan"></span></h3>
  <div id="absenWrapper" class="scrollBox"></div>
  <button onclick="hariBerikutnya()">Hari Berikutnya</button>
  <button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<div id="rekapAbsenScreen" class="screen">
  <h3 style="text-align:center;">REKAP ABSENSI</h3>
  <div id="rekapAbsenWrapper" class="scrollBox"></div>
  <button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<div id="rekapNilaiScreen" class="screen">
  <h3 style="text-align:center;">REKAP NILAI</h3>
  <div id="rekapNilaiWrapper" class="scrollBox"></div>
  <button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<div id="khodamScreen" class="screen">
  <input id="khodamName" placeholder="Masukkan nama...">
  <button onclick="generateKhodam()" class="yellow">Cek Khodam</button>
  <div id="khodamResult" style="margin-top:10px;font-size:1rem;"></div>
  <button class="blue" onclick="showScreen('login')">Kembali</button>
</div>
<script>
/* ============================
   SOAL RAMADHAN KELAS 3 (30)
============================ */
const poolRamadhan = [

{q:"Ramadhan adalah bulan ke berapa dalam kalender Hijriah?", o:["Kesembilan","Ketujuh","Kedua","Pertama"], a:0},
{q:"Puasa Ramadhan hukumnya bagi umat Islam adalah?", o:["Wajib","Sunnah","Makruh","Haram"], a:0},
{q:"Saat berpuasa, kita dilarang makan dan minum mulai dari?", o:["Subuh sampai Maghrib","Subuh sampai Isya","Maghrib sampai Subuh","Dhuha sampai Ashar"], a:0},
{q:"Sahur adalah kegiatan makan sebelum?", o:["Subuh","Maghrib","Isya","Ashar"], a:0},
{q:"Berbuka puasa dilakukan ketika waktu?", o:["Maghrib","Subuh","Isya","Dzuhur"], a:0},
{q:"Niat puasa Ramadhan dilakukan pada waktu?", o:["Malam hari","Pagi hari","Siang hari","Sore hari"], a:0},
{q:"Yang membatalkan puasa adalah?", o:["Makan dan minum","Tidur","Belajar","Bermain"], a:0},
{q:"Lailatul Qadar terjadi pada sepuluh malam terakhir bulan?", o:["Ramadhan","Syawal","Rajab","Muharram"], a:0},
{q:"Zakat fitrah dikeluarkan sebelum?", o:["Sholat Idul Fitri","Sholat Jumat","Sholat Ashar","Sholat Tahajud"], a:0},
{q:"Zakat fitrah dibayarkan menggunakan?", o:["Beras/makanan pokok","Buah-buahan","Air mineral","Pakaian"], a:0},
{q:"Sholat sunnah yang dilakukan di malam Ramadhan adalah?", o:["Tarawih","Witir","Dhuha","Istikharah"], a:0},
{q:"Orang yang sakit dan tidak puasa wajib?", o:["Mengganti di hari lain","Tetap puasa","Tidak perlu ganti puasa","Puasa setengah hari"], a:0},
{q:"Berbuka puasa disunnahkan dengan?", o:["Kurma","Kue","Buah semangka","Air es"], a:0},
{q:"Sholat Idul Fitri dilaksanakan pada tanggal 1 bulan?", o:["Syawal","Ramadhan","Muharram","Rajab"], a:0},
{q:"Bulan Ramadhan disebut juga bulan?", o:["Ampunan","Kesedihan","Larangan","Kemewahan"], a:0},
{q:"Orang yang berpuasa harus menahan?", o:["Lapar dan hawa nafsu","Tidur","Belajar","Olahraga"], a:0},
{q:"Sholat tarawih biasanya dilakukan setelah sholat?", o:["Isya","Subuh","Ashar","Dzuhur"], a:0},
{q:"Iftar artinya adalah?", o:["Berbuka puasa","Sahur","Tidur","Minum"], a:0},
{q:"Tanda masuknya waktu Subuh adalah munculnya?", o:["Fajar","Matahari","Bintang","Rembulan"], a:0},
{q:"Syawal merupakan bulan setelah bulan?", o:["Ramadhan","Muharram","Rajab","Dzulhijjah"], a:0},
{q:"Orang yang sengaja makan saat puasa maka puasanya?", o:["Batal","Tetap sah","Makruh","Sunnah"], a:0},
{q:"Puasa melatih kita untuk menjadi pribadi yang?", o:["Sabar","Marah","Iri","Sombong"], a:0},
{q:"Anak yang belum baligh hukumnya puasa?", o:["Belum wajib","Wajib","Haram","Sunnah muakkad"], a:0},
{q:"Allah menurunkan Al-Qurâ€™an pada bulan?", o:["Ramadhan","Syawal","Zulkaidah","Rabiul Awal"], a:0},
{q:"Sholat tarawih hukumnya?", o:["Sunnah","Wajib","Makruh","Haram"], a:0},
{q:"Berpuasa artinya menahan diri dari?", o:["Makan, minum dan hawa nafsu","Tidur","Belajar","Bermain"], a:0},
{q:"Zakat fitrah wajib bagi?", o:["Setiap muslim","Setiap orang kaya","Anak yatim saja","Tetangga"], a:0},
{q:"Ketika mendengar adzan Maghrib saat puasa kita harus?", o:["Segera berbuka","Menunda berbuka","Tetap puasa","Tidur dulu"], a:0},
{q:"Puasa Ramadhan dilakukan selama?", o:["Satu bulan","Satu minggu","Dua minggu","Sepuluh hari"], a:0},
{q:"Al-Qurâ€™an turun pada malam?", o:["Lailatul Qadar","Nisfu Syaâ€™ban","Isra Miâ€™raj","Asyura"], a:0},

];
</script>
<script>
/* ============================
   SOAL BALIGH KELAS 4 (40)
============================ */
const poolBaligh = [

{q:"Baligh adalah keadaan dimana seorang anak sudah?", o:["Dibebani hukum syariat","Bebas tanpa aturan","Tidak perlu beribadah","Tidak wajib sholat"], a:0},
{q:"Tanda baligh pada laki-laki adalah?", o:["Mimpi basah","Haidh","Kehamilan","Suara serak"], a:0},
{q:"Tanda baligh pada perempuan adalah?", o:["Haidh","Mimpi basah","Tumbuh kumis","Perut membesar"], a:0},
{q:"Baligh biasanya terjadi pada usia?", o:["9-15 tahun","3-5 tahun","18-25 tahun","30-40 tahun"], a:0},
{q:"Mukallaf berarti orang yang sudah?", o:["Terikat kewajiban agama","Tidak wajib sholat","Boleh meninggalkan puasa","Tidak wajib zakat"], a:0},
{q:"Mimpi basah berarti keluarnya?", o:["Mani","Air mata","Air liur","Keringat"], a:0},
{q:"Haidh biasanya terjadi pada perempuan setiap?", o:["Sebulan sekali","Seminggu dua kali","Setahun sekali","Setiap hari"], a:0},
{q:"Setelah mimpi basah laki-laki wajib?", o:["Mandi junub","Tidur","Minum","Ganti baju"], a:0},
{q:"Setelah haidh perempuan wajib melakukan?", o:["Mandi wajib","Wudhu","Cuci tangan","Tidur siang"], a:0},
{q:"Pubertas adalah masa perubahan dari?", o:["Anak ke dewasa","Dewasa ke tua","Balita ke bayi","Tua ke muda"], a:0},
{q:"Hadats besar terjadi karena?", o:["Junub dan haidh","Tidur","Kentut","Makan"], a:0},
{q:"Untuk menghilangkan hadats besar wajib?", o:["Mandi wajib","Wudhu","Cuci muka","Bersiwak"], a:0},
{q:"Perubahan suara menjadi berat terjadi pada?", o:["Laki-laki","Perempuan","Balita","Orang tua"], a:0},
{q:"Perempuan yang haidh saat Ramadhan maka?", o:["Tidak puasa lalu qadha","Tetap puasa","Tidak perlu qadha","Puasa setengah hari"], a:0},
{q:"Wajib puasa Ramadhan mulai berlaku setelah?", o:["Baligh","Masuk SD","Masuk TK","Bisa membaca"], a:0},
{q:"Tumbuh rambut di ketiak adalah tanda?", o:["Pubertas","Sakit","Kurang tidur","Stress"], a:0},
{q:"Menarche adalah?", o:["Haid pertama","Mimpi pertama","Kumis pertama","Suara pertama"], a:0},
{q:"Keluar mani saat tidur disebut?", o:["Mimpi basah","Haidh","Batuk","Lapar"], a:0},
{q:"Baligh secara agama berarti mulai dikenai?", o:["Kewajiban syariat","Kewajiban pajak","Kewajiban sekolah","Kewajiban kerja"], a:0},
{q:"Contoh kewajiban anak baligh adalah?", o:["Sholat 5 waktu","Tidak sholat","Tidak mandi","Tidak belajar"], a:0},
{q:"Hadats kecil dihilangkan dengan?", o:["Wudhu","Mandi wajib","Tayamum saja","Tidur"], a:0},
{q:"Haidh terjadi pada organ bagian?", o:["Rahim","Jantung","Paru-paru","Hati"], a:0},
{q:"Perubahan emosi saat pubertas adalah?", o:["Mudah tersinggung","Tidak punya emosi","Selalu senang","Selalu sedih"], a:0},
{q:"Mandi wajib dilakukan dengan?", o:["Mengalirkan air ke seluruh tubuh","Cuci muka saja","Cuci tangan saja","Berkumur saja"], a:0},
{q:"Catatan amal seorang mukallaf dicatat oleh?", o:["Malaikat","Guru","Orang tua","Teman"], a:0},
{q:"Baligh pada perempuan ditandai oleh?", o:["Haid","Mimpi basah","Perut buncit","Kumis tumbuh"], a:0},
{q:"Baligh pada laki-laki ditandai oleh?", o:["Mimpi basah","Haid","Perut membesar","Suara makin kecil"], a:0},
{q:"Orang baligh harus menjaga?", o:["Pandangan","Tidur","Permainan","Hiburan"], a:0},
{q:"Setelah junub wajib melakukan?", o:["Mandi wajib","Cuci tangan","Wudhu saja","Tidur"], a:0},
{q:"Pubertas menyebabkan perubahan?", o:["Fisik dan emosi","Cuaca","Waktu","Tanah"], a:0},
{q:"Cairan yang keluar saat mimpi basah disebut?", o:["Mani","Air mata","Keringat","Darah"], a:0},
{q:"Haidh yang berhenti berarti perempuan sudah?", o:["Suci","Sakit","Panas","Mengantuk"], a:0},
{q:"Baligh adalah awal taklif yaitu?", o:["Kewajiban agama","Kewajiban sekolah","Kewajiban kerja","Kewajiban olahraga"], a:0},
{q:"Dalam Islam, pubertas disebut?", o:["Baligh","Tua","SMA","Balita"], a:0},
{q:"Perubahan fisik yang bukan tanda baligh adalah?", o:["Bersin","Mimpi basah","Haid","Tumbuh rambut"], a:0},
{q:"Haidh terjadi karena pelepasan?", o:["Dinding rahim","Hormon jantung","Udara paru-paru","Pembuluh darah otak"], a:0},
{q:"Mandi wajib disebut juga mandi?", o:["Junub","Sunah","Biasa","Hangat"], a:0},
{q:"Junub terjadi karena?", o:["Keluarnya mani","Keringat","Kentut","Haus"], a:0},
{q:"Perempuan haidh tidak boleh?", o:["Sholat","Makan","Minum","Tidur"], a:0},
{q:"Anak baligh harus menjaga aurat terutama saat?", o:["Bertemu orang","Tidur","Makan","Berlari"], a:0},

];
</script>
<script>
/* =======================
   QUIZ ENGINE
======================= */
let student="", kelas="";
let current=[], index=0, score=0;
let timer=300, timeInt=null;
let voiceEnabled=true;

/* MULAI KUIS */
function startQuiz(){
  let n = studentName.value.trim();
  let k = studentClass.value.trim();
  loginError.style.display="none";

  if(!n || !k){
    loginError.innerText="Lengkapi nama & kelas!";
    loginError.style.display="block";
    return;
  }

  student=n;
  kelas=k;

  /* ANTI ULANG (jika repeatMode=OFF) */
  let pernah = nilai.some(v => v.name===student && v.class===kelas);
  if(pernah && !repeatMode){
    loginError.innerText="Kamu sudah mengerjakan kuis!";
    loginError.style.display="block";
    return;
  }

  /* PILIH BANK SOAL */
  if(k==="3A" || k==="3B"){
    current = shuffle([...poolRamadhan]).slice(0,10);
  } else {
    current = shuffle([...poolBaligh]).slice(0,10);
  }

  index=0;
  score=0;
  startTimer();
  showQuestion();
  showScreen('quiz');
}

/* TAMPILKAN SOAL */
function showQuestion(){
  let q=current[index];
  progress.innerText = `Soal ${index+1} / ${current.length}`;
  questionText.innerText = q.q;

  /* ACAK JAWABAN */
  let opts = q.o.map((txt,i)=>({txt,i}));
  opts = shuffle(opts);
  options.innerHTML="";
  nextBtn.disabled=true;

  opts.forEach(o=>{
    let div=document.createElement("div");
    div.className="option";
    div.innerText=o.txt;
    div.onclick=()=>selectOption(div,o.i);
    options.appendChild(div);
  });

  /* TTS */
  if(voiceEnabled) speakText(q.q);
}

/* PILIH JAWABAN */
function selectOption(div,i){
  document.querySelectorAll(".option").forEach(x=>x.classList.remove("selected"));
  div.classList.add("selected");
  current[index].pick=i;
  nextBtn.disabled=false;
}

/* NEXT SOAL */
function nextQuestion(){
  if(current[index].pick===current[index].a) score+=10;
  index++;
  if(index<current.length) showQuestion();
  else finishQuiz();
}

/* TIMER */
function startTimer(){
  clearInterval(timeInt);
  timer=300;
  updateTimer();
  timeInt=setInterval(updateTimer,1000);
}

function updateTimer(){
  timer--;
  if(timer<=0){
    timer=0;
    clearInterval(timeInt);
    finishQuiz();
  }
  let m=Math.floor(timer/60), s=timer%60;
  timerElem.innerText = `Sisa: ${m}:${s<10?"0"+s:s}`;
}

/* TTS */
function speakText(t){
  let u=new SpeechSynthesisUtterance(t);
  u.lang="id-ID"; u.rate=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* SELESAI KUIS */
function finishQuiz(){
  clearInterval(timeInt);
  nameResult.innerText = `${student} (${kelas})`;
  scoreBox.innerText = score;

  saveNilai(student,kelas,score);

  /* AUTO ABSENSI HADIR */
  if(!absensi[kelas]) absensi[kelas]={};
  if(!absensi[kelas][student]) absensi[kelas][student]=Array(30).fill("");
  absensi[kelas][student][hari-1]="H";

  saveAll();
  showScreen('result');
}

/* ALAT BANTU */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    let j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function restart(){ location.reload(); }

function showScreen(id){
  document.querySelectorAll(".screen").forEach(x=>x.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
</script>
<script>
/* =======================
   LOCAL STORAGE
======================= */
let siswa       = JSON.parse(localStorage.getItem("siswaPai")   || "{}");
let absensi     = JSON.parse(localStorage.getItem("absensiPai") || "{}");
let nilai       = JSON.parse(localStorage.getItem("nilaiPai")   || "[]");
let khodamSave  = JSON.parse(localStorage.getItem("khodamPai")  || "{}");
let hari        = parseInt(localStorage.getItem("hariPai")      || "1");
let repeatMode  = localStorage.getItem("repeatMode") === "true";

/* =======================
   LOGIN GURU
======================= */
function openGuruLogin(){
  showScreen('guruLogin');
}

function guruSubmit(){
  let p = guruPass.value.trim();
  guruError.style.display="none";

  if(!p){
    guruError.innerText="Masukkan password!";
    guruError.style.display="block";
    return;
  }

  /* PASSWORD ADMIN */
  if(p === "040698"){
    showScreen('menuAdmin');
  } else {
    guruError.innerText="Password salah!";
    guruError.style.display="block";
  }
}

function logoutGuru(){
  showScreen('login');
}

/* =======================
   MODE ULANG KUIS
======================= */
function toggleRepeat(){
  repeatMode = !repeatMode;
  localStorage.setItem("repeatMode",repeatMode);
  repeatLabel.innerText = repeatMode ? "ON" : "OFF";
}

repeatLabel.innerText = repeatMode ? "ON" : "OFF";

/* =======================
   SIMPAN NILAI
======================= */
function saveNilai(n,k,s){
  nilai.push({
    name:n,
    class:k,
    score:s,
    time:new Date().toLocaleString("id-ID")
  });
  saveAll();
}

/* =======================
   INPUT NAMA SISWA
======================= */
function openNama(){
  loadListNama();
  showScreen('inputNama');
}

function simpanNama(){
  let nama = namaInput.value.trim();
  let k = kelasInput.value.trim();

  if(!nama || !k){
    alert("Lengkapi data!");
    return;
  }

  if(!siswa[k]) siswa[k]=[];
  if(!siswa[k].includes(nama)) siswa[k].push(nama);

  if(!absensi[k]) absensi[k]={};
  if(!absensi[k][nama]) absensi[k][nama]=Array(30).fill("");

  saveAll();
  loadListNama();
  namaInput.value="";
  kelasInput.value="";
}

function loadListNama(){
  listNamaBox.innerHTML="";
  for(let k in siswa){
    listNamaBox.innerHTML+=`<b>${k}</b><br>`;
    siswa[k].forEach(n=>{
      listNamaBox.innerHTML+=`â€¢ ${n}<br>`;
    });
    listNamaBox.innerHTML+=`<br>`;
  }
}

/* =======================
   SAVE SEMUA DATA
======================= */
function saveAll(){
  localStorage.setItem("siswaPai",   JSON.stringify(siswa));
  localStorage.setItem("absensiPai", JSON.stringify(absensi));
  localStorage.setItem("nilaiPai",   JSON.stringify(nilai));
  localStorage.setItem("khodamPai",  JSON.stringify(khodamSave));
  localStorage.setItem("hariPai",    hari);
}
</script>
<script>
/* =======================
   ABSENSI MANUAL
======================= */
function loadAbsensi(){
  if(!Object.keys(siswa).length){
    alert("Belum ada siswa!");
    return;
  }

  hariSpan.innerText = hari;
  absenWrapper.innerHTML = "";

  for(let k in siswa){
    absenWrapper.innerHTML += `<h3 style="color:#2E8B57;">${k}</h3>`;
    siswa[k].forEach(n=>{
      let st = absensi[k][n][hari-1] || "-";
      absenWrapper.innerHTML += `
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <span>${n}</span>
        <div>
          <button onclick="setAbsen('${k}','${n}','H')" style="background:#2ecc71;color:white;border:none;padding:5px 8px;">H</button>
          <button onclick="setAbsen('${k}','${n}','I')" style="background:#f1c40f;color:black;border:none;padding:5px 8px;">I</button>
          <button onclick="setAbsen('${k}','${n}','S')" style="background:#3498db;color:white;border:none;padding:5px 8px;">S</button>
          <button onclick="setAbsen('${k}','${n}','A')" style="background:#e74c3c;color:white;border:none;padding:5px 8px;">A</button>
        </div>
        <span>${st}</span>
      </div>`;
    });
  }

  showScreen('absenScreen');
}

function setAbsen(k,n,s){
  absensi[k][n][hari-1]=s;
  saveAll();
  loadAbsensi();
}

/* =======================
   HARI BERIKUTNYA (MAX 30)
======================= */
function hariBerikutnya(){
  if(hari<30){
    hari++;
    saveAll();
    loadAbsensi();
  } else {
    alert("Absensi maksimal 30 hari!");
  }
}

/* =======================
   REKAP ABSENSI
======================= */
function loadRekapAbsensi(){
  rekapAbsenWrapper.innerHTML="";

  for(let k in siswa){
    let html = `<h3 style="color:#2E8B57;">${k}</h3>`;
    html += `<div style="overflow-x:auto;"><table border="1" cellpadding="4"><tr>
             <th>Nama</th>`;
    for(let i=1;i<=30;i++){ html+=`<th>${i}</th>`; }
    html+=`</tr>`;

    siswa[k].forEach(n=>{
      html+=`<tr><td>${n}</td>`;
      absensi[k][n].forEach(v=>{
        html+=`<td>${v||"-"}</td>`;
      });
      html+=`</tr>`;
    });

    html+=`</table></div>`;
    rekapAbsenWrapper.innerHTML+=html;
  }

  showScreen('rekapAbsenScreen');
}

/* =======================
   REKAP NILAI (RANKING)
======================= */
function loadRekapNilai(){
  rekapNilaiWrapper.innerHTML="";

  ["3A","3B","4A","4B"].forEach(k=>{
    let f = nilai.filter(x=>x.class===k);
    if(!f.length) return;

    f.sort((a,b)=>b.score - a.score);
    let hi=f[0].score;

    let html = `<h3 style="color:#2E8B57;">${k} â€” Highscore: ${hi}</h3>`;
    html+=`<div style="overflow-x:auto;"><table border="1" cellpadding="4">
           <tr><th>No</th><th>Nama</th><th>Nilai</th><th>Waktu</th></tr>`;

    f.forEach((x,i)=>{
      let bg = x.score===hi ? '#fff7a8' : x.score>=80 ? '#d4ffd4' : x.score>=60 ? '#ffe5b5' : '#ffd4d4';
      html+=`<tr style="background:${bg};">
              <td>${i+1}</td>
              <td>${x.name}</td>
              <td>${x.score}</td>
              <td>${x.time}</td>
             </tr>`;
    });

    html+=`</table></div>`;
    rekapNilaiWrapper.innerHTML+=html;
  });

  showScreen('rekapNilaiScreen');
}

/* =======================
   EXPORT EXCEL
======================= */
function exportNilai(){
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(nilai), "Nilai");
  XLSX.writeFile(wb,"rekap_nilai.xlsx");
}

function exportAbsensi(){
  const wb = XLSX.utils.book_new();
  let data=[];

  for(let k in absensi){
    for(let n in absensi[k]){
      data.push({
        kelas:k,
        nama:n,
        status:absensi[k][n].join(",")
      });
    }
  }

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Absensi");
  XLSX.writeFile(wb,"rekap_absensi.xlsx");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* =======================
   MUSIK AUTO ala.mp3
======================= */
let audio = new Audio("./ala.mp3");
let autoStarted = false;

/* Unlock audio untuk mobile */
function unlockAudio(){
  if(!autoStarted){
    autoStarted = true;
    audio.play().then(()=>{
      trackName.innerText = "Memutar: ala.mp3";
    }).catch(()=>{});
  }
}

/* User interaction (dibutuhkan mobile) */
document.addEventListener("click",unlockAudio,{once:true});
document.addEventListener("touchstart",unlockAudio,{once:true});

/* Tombol STOP */
btnStop.onclick = ()=>{
  audio.pause();
  trackName.innerText = "Musik dihentikan";
};

/* Tombol LANJUT = replay */
btnNext.onclick = ()=>{
  audio.currentTime = 0;
  audio.play().catch(()=>{});
  trackName.innerText = "Memutar: ala.mp3";
};

/* Jika autoStarted sudah true, coba start ulang setelah 500ms */
setTimeout(()=>{
  if(autoStarted){
    audio.play().catch(()=>{});
    trackName.innerText = "Memutar: ala.mp3";
  }
},500);
</script>

<script>
/* =======================
   CEK KHODAM + TTS
======================= */
const KHODAM_LIST = [
  "Maung Hitam","Maung Putih","Singa Emas","Harimau Belang",
  "Aura Putih","Aura Hitam","Oncom Legendaris","Tempe Sakti",
  "Rajin Ibadah","Soleh","Solehah","Cacing Baja"
];

function openKhodam(){
  showScreen('khodamScreen');
}

function generateKhodam(){
  let name = khodamName.value.trim();
  if(!name) return alert("Masukkan nama!");

  if(!khodamSave[name]){
    khodamSave[name] = KHODAM_LIST[Math.floor(Math.random()*KHODAM_LIST.length)];
    saveAll();
  }

  let hasil = khodamSave[name];
  khodamResult.innerHTML = `
    <b>${name}</b><br>
    Khodam:<br>
    <span style="color:#2E8B57;font-size:1.2rem;">${hasil}</span><br>
    <i>(hiburan)</i>
  `;

  let u = new SpeechSynthesisUtterance(`${name} memiliki khodam ${hasil}`);
  u.lang="id-ID"; u.rate=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
</script>

<script>
/* =======================
   RESET SEMUA DATA
======================= */
function resetSemua(){
  if(confirm("Reset semua data?")){
    localStorage.clear();
    siswa={}; absensi={}; nilai=[]; khodamSave={}; hari=1;
    alert("Data berhasil direset!");
    location.reload();
  }
}
</script>

</div>
</body>
</html>
