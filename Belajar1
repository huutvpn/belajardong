<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Terpadu PAI SD</title>

<style>
body{margin:0;padding:0;background:#eef5ff;font-family:Arial, sans-serif;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:10px;}
.container{width:100%;max-width:520px;background:white;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.15);padding-bottom:20px;}
header{background:#2E8B57;color:white;text-align:center;padding:15px;font-size:1.3rem;border-radius:12px 12px 0 0;font-weight:bold;}
.screen{display:none;padding:15px;}
.screen.active{display:block;}
input,select{width:100%;padding:10px;margin:6px 0 12px;border-radius:6px;border:1px solid #aaa;font-size:1rem;}
button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:6px;font-weight:bold;color:white;background:#2E8B57;}
button.blue{background:#3498db;}
button.red{background:#e74c3c;}
button.yellow{background:#f1c40f;color:black;}
.option{padding:10px;border:1px solid #aaa;border-radius:6px;margin-top:8px;cursor:pointer;}
.option.selected{background:#d4ffe1;border:2px solid #2E8B57;}
#playlist{border:1px solid #ccc;border-radius:6px;padding:10px;max-height:260px;overflow-y:auto;margin-top:10px;background:#fafafa;}
.track{padding:6px;border-bottom:1px solid #ddd;cursor:pointer;}
.track:hover{background:#e9ffe9;}
.activeTrack{background:#b6ffb6 !important;font-weight:bold;}
.controls{display:flex;gap:6px;margin-top:10px;}
.controls button{flex:1;}
.scrollBox{max-height:350px;overflow-y:auto;border:1px solid #ccc;padding:10px;border-radius:6px;}
.tr-green{background:#d4ffd4;}
.tr-orange{background:#ffe5b5;}
.tr-red{background:#ffd4d4;}
.tr-gold{background:#fff7a8;}
</style>
</head>
<body>
<div class="container">
<header>SISTEM TERPADU PAI SD</header>

<div id="login" class="screen active">
<input id="studentName" placeholder="Nama lengkap...">
<select id="studentClass">
<option value="">Pilih Kelas</option>
<option>3A</option><option>3B</option>
<option>4A</option><option>4B</option>
</select>
<button onclick="startQuiz()">Mulai Kuis</button>
<button class="blue" onclick="openGuruLogin()">Login Guru</button>
<button class="yellow" onclick="openKhodam()">Cek Khodam</button>
<div id="loginError" style="color:red;margin-top:6px;display:none;"></div>
</div>
<div id="quiz" class="screen">
<h3 id="progress"></h3>
<div id="questionText" style="font-size:1.1rem;margin-top:10px;"></div>
<div id="options"></div>
<button id="nextBtn" onclick="nextQuestion()" disabled>Selanjutnya</button>
<div id="timer" style="text-align:center;margin-top:10px;color:#444;"></div>
</div>

<div id="result" class="screen">
<h3>HASIL KUIS</h3>
<p id="nameResult"></p>
<h1 id="scoreBox"></h1>
<button onclick="restart()">Kembali</button>
</div>

<div id="guruLogin" class="screen">
<input id="guruPass" type="password" placeholder="Password Guru...">
<button onclick="guruSubmit()">Masuk</button>
<div id="guruError" style="color:red;margin-top:6px;display:none;"></div>
<button class="blue" onclick="showScreen('login')">Kembali</button>
</div>

<div id="menuAdmin" class="screen">
<h3 style="text-align:center;">MENU GURU</h3>
<button onclick="openNama()">Input Nama</button>
<button onclick="loadAbsensi()">Absensi</button>
<button onclick="loadRekapAbsensi()">Rekap Absensi</button>
<button onclick="loadRekapNilai()">Rekap Nilai</button>
<button onclick="exportNilai()">Export Nilai</button>
<button onclick="exportAbsensi()">Export Absensi</button>
<button onclick="toggleRepeat()">Mode Ulang Kuis: <span id="repeatLabel"></span></button>
<button class="red" onclick="resetSemua()">Reset Semua Data</button>
<button onclick="logoutGuru()">Logout</button>

<h3 style="text-align:center;margin-top:20px;">üéß Playlist Musik</h3>
<div class="controls">
<button id="btnPlay">‚ñ∂ Play</button>
<button id="btnStop" class="red">‚ñ† Stop</button>
<button id="btnShuffle" class="yellow">üîÄ Acak</button>
<button id="btnLoop" class="yellow">üîÅ Ulang</button>
</div>
<div id="musicStatus" style="margin-top:10px;font-size:0.9rem;color:#555;">Memindai lagu...</div>
<div id="playlist"></div>
</div>

<div id="inputNama" class="screen">
<input id="namaInput" placeholder="Nama lengkap...">
<select id="kelasInput">
<option value="">Pilih Kelas</option>
<option>3A</option><option>3B</option>
<option>4A</option><option>4B</option>
</select>
<button onclick="simpanNama()">Simpan</button>
<button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
<div id="listNamaBox" class="scrollBox" style="margin-top:10px;font-size:0.9rem;"></div>
</div>

<div id="absenScreen" class="screen">
<h3 style="text-align:center;">ABSENSI ‚Äî Hari <span id="hariSpan"></span></h3>
<div id="absenWrapper" class="scrollBox"></div>
<button onclick="hariBerikutnya()">Hari Berikutnya</button>
<button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<div id="rekapAbsenScreen" class="screen">
<h3 style="text-align:center;">REKAP ABSENSI</h3>
<div id="rekapAbsenWrapper" class="scrollBox"></div>
<button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<div id="rekapNilaiScreen" class="screen">
<h3 style="text-align:center;">REKAP NILAI</h3>
<div id="rekapNilaiWrapper" class="scrollBox"></div>
<button class="blue" onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<div id="khodamScreen" class="screen">
<input id="khodamName" placeholder="Masukkan nama...">
<button onclick="generateKhodam()" class="yellow">Cek Khodam</button>
<div id="khodamResult" style="margin-top:10px;font-size:1rem;"></div>
<button class="blue" onclick="showScreen('login')">Kembali</button>
</div>
<script>
/* BANK SOAL KELAS 3A & 3B (RAMADHAN) ‚Äî 30 SOAL */
const poolRamadhan = [

{q:"Ramadhan adalah bulan ke berapa dalam kalender Hijriah?", o:["Kesembilan","Ketujuh","Kedua","Pertama"], a:0},
{q:"Puasa Ramadhan hukumnya bagi umat Islam adalah?", o:["Wajib","Sunnah","Makruh","Haram"], a:0},
{q:"Saat berpuasa, kita dilarang makan dan minum mulai dari?", o:["Subuh sampai Maghrib","Subuh sampai Isya","Maghrib sampai Subuh","Dhuha sampai Ashar"], a:0},
{q:"Sahur adalah kegiatan makan sebelum?", o:["Subuh","Maghrib","Isya","Ashar"], a:0},
{q:"Berbuka puasa dilakukan ketika waktu?", o:["Maghrib","Subuh","Isya","Dzuhur"], a:0},
{q:"Niat puasa Ramadhan dilakukan pada waktu?", o:["Malam hari","Pagi hari","Siang hari","Sore hari"], a:0},
{q:"Yang membatalkan puasa adalah?", o:["Makan dan minum","Tidur","Belajar","Bermain"], a:0},
{q:"Lailatul Qadar terjadi pada salah satu malam di sepuluh hari terakhir bulan?", o:["Ramadhan","Syawal","Rajab","Muharram"], a:0},
{q:"Zakat fitrah dikeluarkan sebelum?", o:["Sholat Idul Fitri","Sholat Jumat","Sholat Isya","Sholat Tarawih"], a:0},
{q:"Zakat fitrah dibayarkan menggunakan?", o:["Beras/Makanan pokok","Buah-buahan","Air","Pakaian"], a:0},
{q:"Sholat sunnah yang dilakukan pada malam Ramadhan adalah?", o:["Tarawih","Witir","Dhuha","Tahajud"], a:0},
{q:"Orang yang tidak wajib berpuasa karena sakit wajib?", o:["Mengganti di hari lain","Tetap puasa","Tidak perlu mengganti","Berbuka seenaknya"], a:0},
{q:"Berbuka puasa disunnahkan dengan?", o:["Kurma","Kue","Nasi","Buah saja"], a:0},
{q:"Sholat Idul Fitri dilaksanakan pada tanggal 1 bulan?", o:["Syawal","Ramadhan","Muharram","Rajab"], a:0},
{q:"Bulan Ramadhan disebut juga bulan?", o:["Ampunan","Kesedihan","Hiburan","Larangan"], a:0},
{q:"Orang yang berpuasa harus menahan?", o:["Lapar dan hawa nafsu","Tidur","Belajar","Olahraga"], a:0},
{q:"Tarawih biasanya dilaksanakan setelah sholat?", o:["Isya","Subuh","Dzuhur","Ashar"], a:0},
{q:"Iftar artinya adalah?", o:["Berbuka","Sahur","Tidur","Belajar"], a:0},
{q:"Tanda masuknya waktu Subuh adalah munculnya?", o:["Fajar","Matahari","Rembulan","Bintang"], a:0},
{q:"Syawal merupakan bulan setelah?", o:["Ramadhan","Rajab","Zulhijjah","Muharram"], a:0},
{q:"Orang yang sengaja makan saat puasa hukumnya?", o:["Batal","Sah","Makruh","Tetap sah"], a:0},
{q:"Puasa melatih kita untuk bersikap?", o:["Sabar","Marah","Iri","Sombong"], a:0},
{q:"Anak yang belum baligh hukumnya puasa?", o:["Belum wajib","Wajib","Haram","Makruh"], a:0},
{q:"Allah menurunkan Al-Qur‚Äôan pada bulan?", o:["Ramadhan","Syawal","Dzulqa'dah","Rabiul Awal"], a:0},
{q:"Sholat tarawih hukumnya?", o:["Sunnah","Wajib","Makruh","Haram"], a:0},
{q:"Berpuasa artinya menahan diri dari?", o:["Makan, minum, dan nafsu","Tidur","Berbicara","Belajar"], a:0},
{q:"Zakat fitrah wajib bagi?", o:["Setiap muslim","Setiap orang kaya","Anak yatim saja","Tetangga"], a:0},
{q:"Ketika mendengar adzan Maghrib saat puasa kita harus?", o:["Segera berbuka","Menunda berbuka","Tetap puasa","Menunggu isya"], a:0},
{q:"Puasa Ramadhan dilakukan selama?", o:["Satu bulan","Satu minggu","Tiga hari","Empat puluh hari"], a:0},
{q:"Kitab suci Al-Qur‚Äôan diturunkan pada malam?", o:["Lailatul Qadar","Nisfu Sya‚Äôban","Isra Mi‚Äôraj","Asyura"], a:0},

];
</script>
<script>
/* BANK SOAL KELAS 4A & 4B (BALIGH / PUBERTAS) ‚Äî 40 SOAL */
const poolBaligh = [

{q:"Baligh adalah keadaan dimana seorang anak sudah?", o:["Dibebani hukum syariat","Tidak punya kewajiban","Tidak perlu sholat","Boleh tinggalkan puasa"], a:0},
{q:"Tanda baligh pada anak laki-laki adalah?", o:["Mimpi basah","Haidh","Kehamilan","Suara serak"], a:0},
{q:"Tanda baligh pada anak perempuan adalah?", o:["Haidh","Mimpi basah","Tumbuh kumis","Perut membesar"], a:0},
{q:"Baligh biasanya terjadi pada usia sekitar?", o:["9-15 tahun","3-5 tahun","18-25 tahun","30-40 tahun"], a:0},
{q:"Mukallaf berarti orang yang sudah?", o:["Terikat hukum agama","Bebas aturan","Tidak wajib sholat","Tidak harus berpuasa"], a:0},
{q:"Mimpi basah berarti keluarnya?", o:["Mani","Air mata","Keringat","Air liur"], a:0},
{q:"Haidh biasanya terjadi pada perempuan setiap?", o:["Sebulan sekali","Seminggu sekali","Setahun sekali","Setiap hari"], a:0},
{q:"Setelah mimpi basah, laki-laki wajib?", o:["Mandi junub","Ganti baju","Minum air","Tidur"], a:0},
{q:"Setelah haidh perempuan wajib melakukan?", o:["Mandi wajib","Mandi biasa","Wudhu saja","Tidur siang"], a:0},
{q:"Pubertas adalah masa perubahan dari?", o:["Anak ke dewasa","Bayinya ke balita","Dewasa ke tua","Remaja ke balita"], a:0},
{q:"Hadats besar disebabkan oleh?", o:["Junub dan haidh","Tidur","Kentut","Minum"], a:0},
{q:"Untuk menghilangkan hadats besar wajib?", o:["Mandi wajib","Wudhu","Cuci muka","Tidur"], a:0},
{q:"Perubahan suara menjadi berat terjadi pada?", o:["Laki-laki","Perempuan","Balita","Orang tua"], a:0},
{q:"Perempuan yang haidh saat Ramadhan maka?", o:["Tidak puasa lalu qadha","Tetap puasa","Tidak perlu qadha","Puasa setengah hari"], a:0},
{q:"Wajib puasa Ramadhan mulai berlaku setelah?", o:["Baligh","Masuk TK","Masuk SD","Bisa membaca"], a:0},
{q:"Tumbuh rambut di ketiak dan kemaluan adalah tanda?", o:["Pubertas","Sakit","Malas","Kurang tidur"], a:0},
{q:"Menarche adalah?", o:["Haid pertama","Mimpi pertama","Kumis pertama","Suara pertama"], a:0},
{q:"Keluar mani saat tidur disebut?", o:["Mimpi basah","Haidh","Batuk","Lapar"], a:0},
{q:"Baligh secara agama berarti mulai dikenai?", o:["Kewajiban syariat","Kewajiban pajak","Kewajiban sekolah","Bebas aturan"], a:0},
{q:"Contoh kewajiban anak baligh adalah?", o:["Sholat 5 waktu","Tidak sholat","Tidak puasa","Tidak mandi"], a:0},
{q:"Hadats kecil dihilangkan dengan?", o:["Wudhu","Mandi wajib","Tidur","Makan"], a:0},
{q:"Haidh terjadi pada organ bagian?", o:["Rahim","Jantung","Paru-paru","Hati"], a:0},
{q:"Perubahan emosi saat pubertas adalah?", o:["Mudah tersinggung","Tidak punya emosi","Selalu sedih","Selalu senang"], a:0},
{q:"Mandi wajib dilakukan dengan cara?", o:["Mengalirkan air ke seluruh tubuh","Cuci muka saja","Cuci tangan","Berkumur 3 kali"], a:0},
{q:"Seorang mukallaf pribadinya dicatat oleh?", o:["Malaikat","Guru","Orang tua","Teman"], a:0},
{q:"Baligh pada perempuan ditandai oleh?", o:["Haid","Mimpi basah","Kumis tumbuh","Suara serak"], a:0},
{q:"Baligh pada laki-laki ditandai oleh?", o:["Mimpi basah","Haid","Perut buncit","Rambut gondrong"], a:0},
{q:"Orang baligh harus menjaga?", o:["Pandangan","Makanan","Rumah","Laptop"], a:0},
{q:"Setelah junub wajib?", o:["Mandi wajib","Gosok gigi","Minum air","Makan"], a:0},
{q:"Pubertas menyebabkan perubahan?", o:["Fisik dan emosi","Cuaca","Tanah","Waktu"], a:0},
{q:"Zat cair yang keluar saat mimpi basah disebut?", o:["Mani","Air mata","Keringat","Lendir"], a:0},
{q:"Haidh yang berhenti berarti perempuan sudah?", o:["Suci","Sakit","Malas","Mengantuk"], a:0},
{q:"Baligh adalah awal taklif yaitu?", o:["Kewajiban agama","Kewajiban sekolah","Kewajiban kerja","Kewajiban olahraga"], a:0},
{q:"Dalam Islam, pubertas disebut?", o:["Baligh","SMA","Kuliah","Tua"], a:0},
{q:"Perubahan fisik bukan tanda baligh yaitu?", o:["Bersin","Mimpi basah","Haid","Tumbuh rambut"], a:0},
{q:"Haidh terjadi karena pelepasan?", o:["Dinding rahim","Usus","Hati","Otak"], a:0},
{q:"Mandi wajib disebut juga mandi?", o:["Junub","Sunnah","Biasa","Semprot"], a:0},
{q:"Junub terjadi karena?", o:["Keluarnya mani","Berkeringat","Panas","Tidur"], a:0},
{q:"Perempuan yang haidh tidak boleh?", o:["Sholat","Mandi","Makan","Tidur"], a:0},
{q:"Anak baligh harus mulai menjaga aurat terutama saat?", o:["Bersosialisasi","Tidur","Berlari","Makan"], a:0},

];
</script>
<script>
/* QUIZ ENGINE + ACak Soal + ACak Jawaban + TTS + ABSENSI + ANTI ULANG */

let student="", kelas="", current=[], index=0, score=0, timer=300, timeInt=null;
let voiceEnabled=true;

/* START QUIZ */
function startQuiz(){
  let n = studentName.value.trim();
  let k = studentClass.value.trim();
  loginError.style.display="none";

  if(!n || !k){
    loginError.innerText="Lengkapi nama & kelas!";
    loginError.style.display="block";
    return;
  }

  student = n;
  kelas = k;

  /* üîí ANTI ULANG SELAMANYA */
  let pernah = nilai.some(v => v.name===student && v.class===kelas);

  if(pernah && !repeatMode){
    loginError.innerText="Kamu sudah mengerjakan kuis!";
    loginError.style.display="block";
    return;
  }

  /* PILIH SOAL BERDASARKAN KELAS */
  if(k==="3A" || k==="3B"){
    current = shuffle([...poolRamadhan]).slice(0,10);
  } else {
    current = shuffle([...poolBaligh]).slice(0,10);
  }

  index=0;
  score=0;
  startTimer();
  showQuestion();
  showScreen('quiz');
}

/* TAMPILKAN SOAL */
function showQuestion(){
  let q = current[index];
  progress.innerText = `Soal ${index+1} / ${current.length}`;
  questionText.innerText = q.q;

  /* ACak Jawaban (opts: {txt, i}) */
  let opts = q.o.map((txt,i)=>({txt, i}));
  opts = shuffle(opts);

  options.innerHTML="";
  nextBtn.disabled=true;

  opts.forEach(obj=>{
    let div=document.createElement("div");
    div.className="option";
    div.innerText=obj.txt;
    div.onclick=()=>selectOption(div,obj.i);
    options.appendChild(div);
  });

  /* TTS */
  if(voiceEnabled) speakText(q.q);
}

/* PILIH JAWABAN */
function selectOption(div,i){
  document.querySelectorAll(".option").forEach(x=>x.classList.remove("selected"));
  div.classList.add("selected");
  current[index].pick=i;
  nextBtn.disabled=false;
}

/* NEXT SOAL */
function nextQuestion(){
  if(current[index].pick === current[index].a) score+=10;
  index++;
  if(index < current.length) showQuestion();
  else finishQuiz();
}

/* TIMER */
function startTimer(){
  clearInterval(timeInt);
  timer=300;
  timerUpdate();
  timeInt=setInterval(timerUpdate,1000);
}

function timerUpdate(){
  timer--;
  if(timer<=0){
    timer=0;
    clearInterval(timeInt);
    finishQuiz();
  }
  let m=Math.floor(timer/60);
  let s=timer%60;
  document.getElementById("timer").innerText = "Sisa waktu: "+m+":"+(s<10?"0"+s:s);
}

/* TTS ENGINE */
function speakText(text){
  let u=new SpeechSynthesisUtterance(text);
  u.lang="id-ID";
  u.rate=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* KUIS SELESAI */
function finishQuiz(){
  clearInterval(timeInt);
  nameResult.innerText = student+" ("+kelas+")";
  scoreBox.innerText = score;

  /* SIMPAN NILAI */
  saveNilai(student,kelas,score);

  /* AUTO ABSENSI HADIR */
  if(!absensi[kelas]) absensi[kelas]={};
  if(!absensi[kelas][student]) absensi[kelas][student]=Array(30).fill("");
  absensi[kelas][student][hari-1]="H";

  saveAll();
  showScreen('result');
}

/* TOOLS */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    let j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function restart(){ location.reload(); }

function showScreen(id){
  document.querySelectorAll(".screen").forEach(x=>x.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
</script>
<script>
/* LOCAL STORAGE */
let siswa = JSON.parse(localStorage.getItem("siswaPai") || "{}");
let absensi = JSON.parse(localStorage.getItem("absensiPai") || "{}");
let nilai = JSON.parse(localStorage.getItem("nilaiPai") || "[]");
let khodamSave = JSON.parse(localStorage.getItem("khodamPai") || "{}");
let hari = parseInt(localStorage.getItem("hariPai") || "1");
let repeatMode = localStorage.getItem("repeatMode") === "true";

/* LOGIN GURU */
function openGuruLogin(){
  showScreen('guruLogin');
}

function guruSubmit(){
  let p = guruPass.value.trim();
  guruError.style.display="none";

  if(!p){
    guruError.innerText="Masukkan password!";
    guruError.style.display="block";
    return;
  }

  /* PASSWORD ADMIN */
  if(p === "040698"){
    showScreen('menuAdmin');
  } else {
    guruError.innerText="Password salah!";
    guruError.style.display="block";
  }
}

function logoutGuru(){
  showScreen('login');
}

/* MODE ULANG KUIS */
function toggleRepeat(){
  repeatMode = !repeatMode;
  localStorage.setItem("repeatMode",repeatMode);
  repeatLabel.innerText = repeatMode ? "ON" : "OFF";
}
repeatLabel.innerText = repeatMode ? "ON" : "OFF";

/* SIMPAN NILAI */
function saveNilai(n,k,s){
  nilai.push({
    name:n,
    class:k,
    score:s,
    time:new Date().toLocaleString("id-ID")
  });
  saveAll();
}

/* INPUT NAMA SISWA */
function openNama(){
  loadListNama();
  showScreen('inputNama');
}

function simpanNama(){
  let nama = namaInput.value.trim();
  let k = kelasInput.value;

  if(!nama || !k){
    alert("Lengkapi data!");
    return;
  }

  if(!siswa[k]) siswa[k] = [];
  if(!siswa[k].includes(nama)) siswa[k].push(nama);

  if(!absensi[k]) absensi[k] = {};
  if(!absensi[k][nama]) absensi[k][nama]=Array(30).fill("");

  saveAll();
  loadListNama();
  namaInput.value="";
  kelasInput.value="";
}

function loadListNama(){
  listNamaBox.innerHTML="";
  for(let k in siswa){
    listNamaBox.innerHTML+=`<b>${k}</b><br>`;
    siswa[k].forEach(n=> listNamaBox.innerHTML+=`‚Ä¢ ${n}<br>`);
    listNamaBox.innerHTML+="<br>";
  }
}

/* SAVE SEMUA */
function saveAll(){
  localStorage.setItem("siswaPai",JSON.stringify(siswa));
  localStorage.setItem("absensiPai",JSON.stringify(absensi));
  localStorage.setItem("nilaiPai",JSON.stringify(nilai));
  localStorage.setItem("khodamPai",JSON.stringify(khodamSave));
  localStorage.setItem("hariPai",hari);
}
</script>
<script>
/* ABSENSI MANUAL */
function loadAbsensi(){
  if(!Object.keys(siswa).length){
    alert("Belum ada siswa!");
    return;
  }

  hariSpan.innerText = hari;
  absenWrapper.innerHTML = "";

  for(let k in siswa){
    absenWrapper.innerHTML += `<h3 style="color:#2E8B57;">${k}</h3>`;
    siswa[k].forEach(n=>{
      let st = absensi[k][n][hari-1] || "-";
      absenWrapper.innerHTML += `
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <span>${n}</span>
        <div>
          <button onclick="setAbsen('${k}','${n}','H')" style="background:#2ecc71;color:white;border:none;padding:5px 8px;">H</button>
          <button onclick="setAbsen('${k}','${n}','I')" style="background:#f1c40f;color:black;border:none;padding:5px 8px;">I</button>
          <button onclick="setAbsen('${k}','${n}','S')" style="background:#3498db;color:white;border:none;padding:5px 8px;">S</button>
          <button onclick="setAbsen('${k}','${n}','A')" style="background:#e74c3c;color:white;border:none;padding:5px 8px;">A</button>
        </div>
        <span>${st}</span>
      </div>`;
    });
  }

  showScreen('absenScreen');
}

function setAbsen(k,n,s){
  absensi[k][n][hari-1]=s;
  saveAll();
  loadAbsensi();
}

/* HARI BERIKUTNYA */
function hariBerikutnya(){
  if(hari < 30){
    hari++;
    saveAll();
    loadAbsensi();
  } else {
    alert("Absensi hanya 30 hari!");
  }
}

/* REKAP ABSENSI */
function loadRekapAbsensi(){
  rekapAbsenWrapper.innerHTML="";

  for(let k in siswa){
    let html = `<h3 style="color:#2E8B57;">${k}</h3>`;
    html += `<div style="overflow-x:auto;"><table border="1" cellpadding="4"><tr>
             <th>Nama</th>`;
    for(let i=1;i<=30;i++){ html+=`<th>${i}</th>`; }
    html+=`</tr>`;

    siswa[k].forEach(n=>{
      html+=`<tr><td>${n}</td>`;
      absensi[k][n].forEach(v=>{ html+=`<td>${v||"-"}</td>`; });
      html+=`</tr>`;
    });

    html+=`</table></div>`;
    rekapAbsenWrapper.innerHTML+=html;
  }

  showScreen('rekapAbsenScreen');
}

/* REKAP NILAI (RANKING + WARNA) */
function loadRekapNilai(){
  rekapNilaiWrapper.innerHTML="";

  ["3A","3B","4A","4B"].forEach(k=>{
    let f = nilai.filter(x => x.class===k);
    if(!f.length) return;

    f.sort((a,b)=>b.score - a.score);
    let hi=f[0].score;

    let html = `<h3 style="color:#2E8B57;">${k} ‚Äî Highscore: ${hi}</h3>`;
    html+=`<div style="overflow-x:auto;"><table border="1" cellpadding="4">
           <tr><th>No</th><th>Nama</th><th>Nilai</th><th>Waktu</th></tr>`;

    f.forEach((x,i)=>{
      let rowColor = x.score===hi ? '#fff7a8' : x.score>=80 ? '#d4ffd4' : x.score>=60 ? '#ffe5b5' : '#ffd4d4';
      html+=`<tr style="background:${rowColor};">
              <td>${i+1}</td>
              <td>${x.name}</td>
              <td>${x.score}</td>
              <td>${x.time}</td>
             </tr>`;
    });

    html+=`</table></div>`;
    rekapNilaiWrapper.innerHTML+=html;
  });

  showScreen('rekapNilaiScreen');
}

/* EXPORT EXCEL */
function exportNilai(){
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(nilai), "Nilai");
  XLSX.writeFile(wb,"rekap_nilai.xlsx");
}

function exportAbsensi(){
  const wb = XLSX.utils.book_new();
  let data=[];

  for(let k in absensi){
    for(let n in absensi[k]){
      data.push({
        kelas:k,
        nama:n,
        status:absensi[k][n].join(",")
      });
    }
  }

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Absensi");
  XLSX.writeFile(wb,"rekap_absensi.xlsx");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* CEK KHODAM + SUARA TTS */
const KHODAM_LIST = [
  "Maung Hitam","Maung Putih","Harimau Belang","Singa Emas",
  "Aura Putih","Aura Hitam","Oncom Legendaris","Tempe Sakti",
  "Rajin Ibadah","Soleh","Solehah","Cacing Baja"
];

function openKhodam(){
  showScreen('khodamScreen');
}

function generateKhodam(){
  let name = khodamName.value.trim();
  if(!name) return alert("Masukkan nama!");

  if(!khodamSave[name]){
    khodamSave[name] = KHODAM_LIST[Math.floor(Math.random()*KHODAM_LIST.length)];
    saveAll();
  }

  let hasil = khodamSave[name];
  let text = `${name} memiliki khodam ${hasil}`;

  khodamResult.innerHTML = `
  <b>${name}</b><br>
  Khodam:<br>
  <span style="color:#2E8B57;font-size:1.2rem;">${hasil}</span><br>
  <i>(hiburan)</i>
  `;

  /* üîä BACA OTOMATIS */
  let u = new SpeechSynthesisUtterance(text);
  u.lang="id-ID";
  u.rate=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* RESET SEMUA DATA */
function resetSemua(){
  if(confirm("Reset semua data?")){
    localStorage.clear();
    siswa={}; absensi={}; nilai=[]; khodamSave={}; hari=1;
    alert("Semua data berhasil direset!");
    location.reload();
  }
}
</script>

<script>
/* MUSIC ENGINE 10.000 FILE */
const MAX_MUSIC=10000;
const MUSIC_FOLDER="music/";
let rawList=["ala.mp3"];
for(let i=1;i<=MAX_MUSIC;i++){ rawList.push(i+".mp3"); }

let playlist=[];
let audio=new Audio();
let unlocked=false, loopMode=false, shuffleMode=true, playingIndex=-1;

async function exists(url){
  try{
    let r=await fetch(url,{method:"HEAD"});
    return r.ok;
  }catch(e){ return false; }
}

async function loadPlaylist(){
  musicStatus.innerText="Memindai lagu...";
  for(let file of rawList){
    let path=MUSIC_FOLDER+file;
    if(await exists(path)){
      playlist.push(path);
      addTrackUI(path);
    }
  }
  musicStatus.innerText = playlist.length===0
    ? "‚ùå Tidak ada lagu ditemukan"
    : `‚úî Ditemukan ${playlist.length} lagu`;
}

function addTrackUI(path){
  let box=document.getElementById("playlist");
  let div=document.createElement("div");
  div.className="track";
  div.innerText=path.replace(MUSIC_FOLDER,"");
  div.onclick=()=>playByPath(path);
  box.appendChild(div);
}

function playByIndex(i){
  if(i<0||i>=playlist.length)return;
  playingIndex=i;
  audio.src=playlist[i];
  audio.play().catch(()=>{});
  updateActive();
  musicStatus.innerText="‚ñ∂ Memutar: "+playlist[i].replace(MUSIC_FOLDER,"");
}

function playByPath(path){
  let idx=playlist.indexOf(path);
  if(idx>=0) playByIndex(idx);
}

function playNextRandom(){
  if(playlist.length===0)return;
  let next;
  do{ next=Math.floor(Math.random()*playlist.length); }
  while(playlist.length>1 && next===playingIndex);
  playByIndex(next);
}

/* BUTTONS */
btnPlay.onclick=()=>{
  if(!unlocked) unlockAudio();
  if(playingIndex===-1){
    shuffleMode? playNextRandom() : playByIndex(0);
  } else audio.play().catch(()=>{});
};
btnStop.onclick=()=>audio.pause();
btnShuffle.onclick=()=>{
  shuffleMode=!shuffleMode;
  btnShuffle.innerText=shuffleMode?"üîÄ Acak":"‚û° Urut";
};
btnLoop.onclick=()=>{
  loopMode=!loopMode;
  btnLoop.innerText=loopMode?"üîÅ Ulang ON":"üîÅ Ulang";
};

audio.onended=()=>{
  if(shuffleMode){
    playNextRandom();
  } else {
    let next=playingIndex+1;
    if(next>=playlist.length){
      loopMode? playByIndex(0) : audio.pause();
    }else playByIndex(next);
  }
};

function unlockAudio(){
  unlocked=true;
  audio.play().catch(()=>{});
}
document.addEventListener("click",unlockAudio,{once:true});
document.addEventListener("touchstart",unlockAudio,{once:true});

function updateActive(){
  document.querySelectorAll(".track").forEach(el=>el.classList.remove("activeTrack"));
  let t=playlist[playingIndex];
  document.querySelectorAll(".track").forEach(el=>{
    if(el.innerText===t.replace(MUSIC_FOLDER,"")) el.classList.add("activeTrack");
  });
}

loadPlaylist();
</script>

</div>
</body>
</html>
