<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kuis & Absensi PAI SD</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2E8B57;
  --light:#F0FFF0;
  --danger:#e74c3c;
  --white:#fff;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{
  background:var(--light);display:flex;justify-content:center;
  align-items:flex-start;min-height:100vh;padding:20px;
}
.app{
  background:var(--white);width:100%;max-width:900px;
  border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.2);
  overflow:hidden;
}
header{
  background:var(--primary);color:#fff;padding:18px;text-align:center;
  font-weight:bold;font-size:1.2rem;
}
.logo{
  width:120px;height:120px;border-radius:50%;object-fit:cover;
  display:block;margin:15px auto 10px;border:3px solid var(--primary);
}
.screen{display:none;padding:20px;}
.screen.active{display:block;}
button{
  width:100%;padding:12px;font-weight:bold;color:#fff;
  background:var(--primary);border:none;border-radius:8px;
  margin-top:10px;cursor:pointer;
}
.btn-danger{background:var(--danger);}
input,select{
  width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;margin-top:5px;
}
.scrollBox{
  max-height:400px;overflow-y:auto;margin-top:10px;
}
table{
  border-collapse:collapse;margin-top:10px;font-size:.8rem;width:100%;
}
th,td{
  border:1px solid #bbb;padding:5px;text-align:center;
}
th{background:var(--primary);color:#fff;}
.statusRow{
  display:flex;justify-content:space-between;align-items:center;
  border:1px solid #ccc;padding:8px;margin:5px 0;border-radius:6px;
}
.absenBtn{
  padding:6px 8px;margin:2px;color:#fff;border-radius:4px;
  cursor:pointer;font-size:.8rem;
}
.h{background:#2ecc71;} .i{background:#f1c40f;}
.s{background:#3498db;} .a{background:#e74c3c;}
.question-card{
  background:#fafafa;padding:15px;border-left:4px solid gold;
  margin:10px 0;border-radius:8px;
}
.option{
  border:2px solid #ccc;padding:10px;border-radius:8px;
  margin:8px 0;cursor:pointer;
}
.option.selected{
  background:var(--primary);color:#fff;border-color:var(--primary);
}
.score-circle{
  width:140px;height:140px;border-radius:50%;
  background:var(--primary);color:#fff;
  display:flex;justify-content:center;align-items:center;
  font-size:2.5rem;margin:15px auto;
}
.tr-gold{background:gold;color:black;font-weight:bold;}
.tr-green{background:#2ecc71;color:white;}
.tr-orange{background:orange;color:white;}
.tr-red{background:#e74c3c;color:white;}

#khodamResult{
  background:#fff;
  padding:12px;
  border-radius:8px;
  border:2px solid var(--primary);
  margin-top:15px;
  text-align:center;
  line-height:1.6rem;
}
</style>
</head>
<body>
<div class="app">

<header>KUIS & ABSENSI PAI SD</header>

<!-- ================= LOGIN SISWA ================= -->
<div id="login" class="screen active">

  <img src="logo.jpg" class="logo">

  <h3 style="text-align:center;margin-top:10px;">LOGIN SISWA</h3>

  <label>Nama</label>
  <input id="studentName" autocomplete="off">

  <label style="margin-top:8px;">Kelas</label>
  <select id="studentClass">
    <option disabled selected>Pilih Kelas</option>
    <option>3A</option>
    <option>3B</option>
    <option>4A</option>
    <option>4B</option>
  </select>

  <small id="loginError" style="color:red;display:none;"></small>

  <button onclick="startQuiz()">Mulai Kuis</button>
  <button onclick="openGuruLogin()">Login Guru</button>
  <button onclick="toggleMusic()">Musik</button>
  <button onclick="openKhodam()">Cek Khodam</button>
  </div>

<!-- ================= LOGIN GURU ================= -->
<div id="guruLogin" class="screen">

  <h3 style="text-align:center;">LOGIN GURU</h3>

  <label>Password</label>
  <input id="guruPass" type="password" autocomplete="off">

  <small id="guruError" style="color:red;display:none;"></small>

  <button onclick="guruSubmit()">Masuk</button>
  <button onclick="showScreen('login')">Kembali</button>
</div>

<!-- ================= QUIZ ================= -->
<div id="quiz" class="screen">

  <div style="display:flex;justify-content:space-between;">
    <span id="progress"></span>
    <span id="kelasTag" style="color:var(--primary);font-weight:bold;"></span>
  </div>

  <div id="timer" style="font-size:18px;color:red;font-weight:bold;text-align:right;margin-top:5px;"></div>

  <div class="question-card">
    <div id="questionText"></div>
  </div>

  <div id="options"></div>

  <button id="nextBtn" onclick="nextQuestion()" disabled>Selanjutnya</button>
</div>

<!-- ================= RESULT ================= -->
<div id="result" class="screen">
  <h3 style="text-align:center;">Kuis Selesai!</h3>
  <h4 id="nameResult" style="text-align:center;"></h4>
  <div id="scoreBox" class="score-circle"></div>
  <button onclick="restart()">Kembali Awal</button>
</div>

<!-- ================= MENU GURU ================= -->
<div id="menuAdmin" class="screen">
  <h3 style="text-align:center;">MENU GURU</h3>

  <button onclick="showScreen('inputNama')">Input Nama Siswa</button>
  <button onclick="loadAbsensi()">Input Absensi</button>
  <button onclick="loadRekapAbsensi()">Rekap Absensi</button>
  <button onclick="loadRekapNilai()">Rekap Nilai</button>

  <button onclick="exportNilai()">Export Nilai (Excel)</button>
  <button onclick="exportAbsensi()">Export Absensi (Excel)</button>

  <button onclick="toggleRepeat()">Mode Ulang Kuis: <span id="repeatLabel"></span></button>

  <button onclick="openKhodam()">Cek Khodam</button>

  <button class="btn-danger" onclick="resetSemua()">Reset Semua Data</button>
  <button onclick="logoutGuru()">Logout Guru</button>
</div>

<!-- ================= INPUT NAMA SISWA ================= -->
<div id="inputNama" class="screen">
  <h3 style="text-align:center;">INPUT NAMA</h3>

  <input id="namaInput" placeholder="Nama Siswa" autocomplete="off">

  <select id="kelasInput">
    <option disabled selected>Pilih Kelas</option>
    <option>3A</option>
    <option>3B</option>
    <option>4A</option>
    <option>4B</option>
  </select>

  <button onclick="simpanNama()">Simpan Nama</button>
  <button onclick="showScreen('menuAdmin')">Kembali</button>

  <div class="scrollBox" id="listNamaBox"></div>
</div>

<!-- ================= ABSENSI ================= -->
<div id="absenScreen" class="screen">
  <h3 style="text-align:center;">ABSENSI HARI <span id="hariSpan"></span></h3>

  <div class="scrollBox" id="absenWrapper"></div>

  <button onclick="hariBerikutnya()">Hari Berikutnya ‚Üí</button>
  <button onclick="showScreen('menuAdmin')">Kembali</button>
</div>
<!-- ================= REKAP ABSENSI ================= -->
<div id="rekapAbsenScreen" class="screen">
  <h3 style="text-align:center;">REKAP ABSENSI</h3>

  <div class="scrollBox" id="rekapAbsenWrapper"></div>

  <button onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<!-- ================= REKAP NILAI ================= -->
<div id="rekapNilaiScreen" class="screen">
  <h3 style="text-align:center;">REKAP NILAI</h3>

  <div class="scrollBox" id="rekapNilaiWrapper"></div>

  <button onclick="showScreen('menuAdmin')">Kembali</button>
</div>

<!-- ================= CEK KHODAM ================= -->
<div id="khodamScreen" class="screen">
  <h3 style="text-align:center;">CEK KHODAM HIBURAN</h3>

  <label>Masukkan Nama</label>
  <input id="khodamName" placeholder="Nama lengkap" autocomplete="off">

  <button onclick="generateKhodam()">Cek Sekarang</button>
  <button onclick="showScreen('login')">Kembali</button>

  <div id="khodamResult"></div>
</div>

<!-- ================= BANK SOAL ================= -->
<script>
const pool3 = [
  {q:"Apa nama bulan ketika umat Islam wajib berpuasa?", opts:["Rajab","Ramadhan","Syawal","Muharram"], a:1},
  {q:"Puasa Ramadhan hukumnya bagi yang mampu adalah?", opts:["Sunnah","Makruh","Wajib","Mubah"], a:2},
  {q:"Puasa dimulai dari terbit ____ hingga terbenam matahari.", opts:["Bulan","Matahari","Fajar","Bintang"], a:2},
  {q:"Puasa diakhiri saat masuk waktu shalat apa?", opts:["Subuh","Dzuhur","Maghrib","Isya"], a:2},
  {q:"Niat puasa Ramadhan dilakukan pada waktu?", opts:["Subuh","Dzuhur","Ashar","Malam"], a:3},
  {q:"Bulan Ramadhan disebut juga bulan?", opts:["Musibah","Fitnah","Berkah","Bencana"], a:2},
  {q:"Kitab apa yang diturunkan pada bulan Ramadhan?", opts:["Taurat","Zabur","Al-Qur'an","Injil"], a:2},
  {q:"Istilah malam turunnya Al-Qur'an disebut?", opts:["Nuzulul Qur'an","Haji Wada","Isra Mi'raj","Maulid"], a:0},
  {q:"Malam Lailatul Qadar lebih baik dari ____ bulan.", opts:["10","50","1000","100"], a:2},
  {q:"Sholat tarawih dikerjakan setelah sholat?", opts:["Subuh","Dzuhur","Ashar","Isya"], a:3},

  {q:"Zakat fitrah wajib untuk?", opts:["Yang kaya saja","Yang miskin saja","Setiap muslim","Anak kecil saja"], a:2},
  {q:"Zakat fitrah dikeluarkan sebelum?", opts:["Idul Fitri","Tarawih","Subuh","Isya"], a:0},
  {q:"Batas akhir pembayaran zakat fitrah adalah sebelum?", opts:["Sholat Shubuh","Sholat Tarawih","Sholat Idul Fitri","Sholat Dzuhur"], a:2},
  {q:"Ukuran zakat fitrah adalah sekitar ____ liter beras.", opts:["1 liter","2,5 liter","3 liter","2 liter"], a:1},
  {q:"Sunah berbuka puasa dengan apa?", opts:["Kopi","Kurma","Teh","Nasi"], a:1},
  {q:"Doa berbuka puasa dibaca ketika?", opts:["Sahur","Berbuka","Tarawih","Tidur"], a:1},
  {q:"Sahur dilakukan pada waktu?", opts:["Pagi","Sore","Siang","Menjelang Subuh"], a:3},
  {q:"Orang yang tidak boleh berpuasa adalah?", opts:["Orang sehat","Orang musafir","Orang kuat","Anak baligh"], a:1},
  {q:"Apa hukum makan dan minum saat sahur?", opts:["Haram","Makruh","Sunnah","Wajib"], a:2},
  {q:"Berpuasa berarti menahan diri dari?", opts:["Makan dan minum","Perkataan buruk","Perbuatan dosa","Semua benar"], a:3},

  {q:"Di bulan Ramadhan, umat Islam memperbanyak?", opts:["Tidur","Ibadah","Bergibah","Marah"], a:1},
  {q:"Hari raya setelah Ramadhan disebut?", opts:["Idul Adha","Idul Fitri","Tahun Baru","Maulid Nabi"], a:1},
  {q:"Meng-qadha puasa berarti?", opts:["Menambah","Mengganti","Menunda","Menghapus"], a:1},
  {q:"Qunut witir dibaca pada sholat?", opts:["Subuh","Tarawih","Witir","Dzuhur"], a:2},
  {q:"Salah satu keistimewaan bulan Ramadhan adalah dibukanya pintu?", opts:["Neraka","Istana","Surga","Pasar"], a:2},
  {q:"Siapa yang pertama kali menerima Al-Qur'an?", opts:["Umar","Abu Bakar","Rasulullah SAW","Ibrahim"], a:2},
  {q:"Nuzulul Qur'an diperingati pada tanggal?", opts:["17 Ramadhan","1 Ramadhan","10 Ramadhan","27 Ramadhan"], a:0},
  {q:"Salah satu tanda Lailatul Qadar adalah?", opts:["Siang panas","Malam cerah dan tenang","Hujan deras","Badai"], a:1},
  {q:"Kasus apa yang membolehkan berbuka puasa?", opts:["Sakit parah","Safar jauh","Hamil/menyusui","Semua benar"], a:3},
  {q:"Siapa yang diperintahkan berpuasa dalam Al-Qur'an?", opts:["Muslim dan muslimah","Kafir","Anak kecil","Semua manusia"], a:0}
];

const pool4 = [
  {q:"Balig artinya adalah usia dimana seseorang sudah?", opts:["Boleh bekerja","Memiliki kewajiban agama","Tidak perlu shalat","Wajib menikah"], a:1},
  {q:"Orang yang sudah balig disebut juga?", opts:["Balita","Mukallaf","Musafir","Mustahiq"], a:1},
  {q:"Mukallaf berarti seseorang telah?", opts:["Mampu membeli makanan","Mampu memenuhi kewajiban agama","Boleh keluar negeri","Diangkat jadi ketua"], a:1},
  {q:"Tanda balig pada laki-laki adalah?", opts:["Haidh","Mimpi basah","Sakit perut","Menikah"], a:1},
  {q:"Tanda balig pada perempuan adalah?", opts:["Mimpi basah","Haidh","Disunat","Pergi sekolah"], a:1},
  {q:"Balig biasanya terjadi pada usia sekitar?", opts:["2-4 tahun","6-8 tahun","10-15 tahun","20-30 tahun"], a:2},
  {q:"Haidh adalah tanda balig pada?", opts:["Laki-laki","Perempuan","Anak kecil","Lansia"], a:1},
  {q:"Mimpi basah adalah tanda balig pada?", opts:["Perempuan","Laki-laki","Balita","Orang tua"], a:1},
  {q:"Setelah balig, amal perbuatan manusia dicatat oleh?", opts:["Dewan guru","Malaikat","Orang tua","Ketua RT"], a:1},
  {q:"Balig adalah awal seorang muslim menjadi?", opts:["Mua'allaf","Mukallaf","Musyrik","Munafik"], a:1},

  {q:"Seorang yang telah balig wajib?", opts:["Shalat lima waktu","Tidur siang","Bermain game","Memiliki motor"], a:0},
  {q:"Wajib puasa Ramadhan berlaku pada orang?", opts:["Balita","Belum balig","Sudah balig","Lansia"], a:2},
  {q:"Perubahan fisik saat balig contohnya?", opts:["Tumbuh rambut halus","Tumbuh sayap","Tumbuh duri","Rambut hilang"], a:0},
  {q:"Perubahan suara pada masa balig sering terjadi pada?", opts:["Perempuan","Laki-laki","Balita","Lansia"], a:1},
  {q:"Perubahan emosional saat balig misalnya?", opts:["Mudah marah","Selalu tertawa","Takut naik tangga","Suka makan bubur"], a:0},
  {q:"Perubahan sosial saat balig misalnya?", opts:["Belajar bertanggung jawab","Berhenti sekolah","Tidak mau bermain","Selalu tidur"], a:0},
  {q:"Saat balig, Islam mengajarkan untuk menjaga?", opts:["Akhlak","Mainan","Boneka","Topi"], a:0},
  {q:"Kewajiban seorang muslim setelah balig adalah menjaga?", opts:["Jaket","Waktu shalat","Sepatu","Penghapus"], a:1},
  {q:"Adab mandi setelah mimpi basah adalah?", opts:["Membaca doa tidur","Mandi junub","Berwudhu","Tidak mandi"], a:1},
  {q:"Balig berkaitan erat dengan?", opts:["Harta","Tanggung jawab agama","Kekayaan","Hobi"], a:1},

  {q:"Contoh ibadah yang wajib dilakukan setelah balig adalah?", opts:["Shalat lima waktu","Makan tiga kali","Tidur siang","Main bola"], a:0},
  {q:"Mimpi basah dalam Islam disebut?", opts:["Ihtilam","Haidh","Junub","Wudhu"], a:0},
  {q:"Jika keluar mani karena mimpi maka wajib?", opts:["Mandi junub","Cuci tangan","Cuci kaki","Ganti baju"], a:0},
  {q:"Haidh biasanya terjadi setiap?", opts:["1 jam","Satu bulan","Satu hari","Satu tahun"], a:1},
  {q:"Haidh dialami oleh?", opts:["Balita","Laki-laki","Perempuan balig","Orang tua"], a:2},
  {q:"Jika seseorang telah balig, ia wajib meninggalkan?", opts:["Dosa dan maksiat","Sekolah","Rumah","Teman"], a:0},
  {q:"Jika seseorang belum balig maka dosa belum?", opts:["Dicatat","Diampuni","Dihapus","Diperbesar"], a:0},
  {q:"Balig merupakan ketentuan dari?", opts:["Adat","Allah SWT","Tradisi","Manusia"], a:1},
  {q:"Tujuan menyambut usia balig adalah agar remaja siap menjadi muslim yang?", opts:["Bertanggung jawab","Pemalas","Pemarah","Tidak disiplin"], a:0},
  {q:"Anak yang balig harus belajar menjaga aurat karena?", opts:["Perintah agama","Ikut tren","Tidak penting","Supaya terkenal"], a:0}
];
</script>

<script>
/* ================= BASE STORAGE ================= */
let siswa = JSON.parse(localStorage.getItem("siswaPai") || "{}");
let absensi = JSON.parse(localStorage.getItem("absensiPai") || "{}");
let nilai = JSON.parse(localStorage.getItem("nilaiPai") || "[]");
let hari = parseInt(localStorage.getItem("hariPai") || "1");
let repeatMode = localStorage.getItem("repeatMode") === "true";

/* QUIZ VAR */
let current = [];
let index = 0;
let score = 0;
let student = "";
let kelas = "";

/* TIMER */
let timeLeft = 300;
let timerInterval = null;

/* SPEECH */
const synth = window.speechSynthesis;
function speak(t){
  synth.cancel();
  let u=new SpeechSynthesisUtterance(t);
  u.lang="id-ID";u.rate=0.9;
  synth.speak(u);
}
/* ================= START QUIZ ================= */
function startQuiz(){
  let n = studentName.value.trim();
  let k = studentClass.value;

  loginError.style.display="none";
  if(!n || !k){
    loginError.innerText="Lengkapi data!";
    loginError.style.display="block";
    return;
  }

  if(!repeatMode && nilai.some(x=>x.name===n && x.class===k)){
    loginError.innerText="Sudah mengerjakan!";
    loginError.style.display="block";
    return;
  }

  student=n; kelas=k;
  kelasTag.innerText="Kelas "+k;

  if(!siswa[k]) siswa[k]=[];
  if(!siswa[k].includes(n)) siswa[k].push(n);

  if(!absensi[k]) absensi[k]={};
  if(!absensi[k][n]) absensi[k][n]=Array(30).fill("");
  absensi[k][n][hari-1]="H";

  saveAll();

  const pool=(k==="3A"||k==="3B")?pool3:pool4;
  current=shuffle([...pool]).slice(0,10);

  index=0;score=0;
  startTimer();
  showQuestion();
  showScreen('quiz');
}

/* ================= SOAL ================= */
function showQuestion(){
  const q=current[index];
  progress.innerText=`Soal ${index+1}/${current.length}`;
  questionText.innerText=q.q;
  speak(q.q);

  options.innerHTML="";
  nextBtn.disabled=true;

  q.opts.forEach((o,i)=>{
    let d=document.createElement("div");
    d.className="option";
    d.innerText=o;
    d.onclick=()=>select(i,d);
    options.appendChild(d);
  });
}

function select(i,el){
  document.querySelectorAll(".option").forEach(e=>e.classList.remove("selected"));
  el.classList.add("selected");
  el.dataset.choice=i;
  nextBtn.disabled=false;
}

function nextQuestion(){
  let c=document.querySelector(".option.selected").dataset.choice;
  if(c==current[index].a) score+=10;
  index++;
  (index<current.length)?showQuestion():finishQuiz();
}

/* ================= FINISH QUIZ ================= */
function finishQuiz(){
  clearInterval(timerInterval);
  nilai.push({
    name:student,class:kelas,score,
    time:new Date().toLocaleString("id-ID")
  });
  saveAll();
  nameResult.innerText=`${student} (${kelas})`;
  scoreBox.innerText=score;
  showScreen('result');
}

/* ================= TIMER ================= */
function startTimer(){
  timeLeft=300;
  updateTimer();
  timerInterval=setInterval(()=>{
    timeLeft--;
    updateTimer();
    if(timeLeft<=0){
      clearInterval(timerInterval);
      finishQuiz();
    }
  },1000);
}
function updateTimer(){
  let m=Math.floor(timeLeft/60),s=timeLeft%60;
  timer.innerText=`‚è≥ ${m}:${('0'+s).slice(-2)}`;
}

/* ================= LOGIN GURU ================= */
function openGuruLogin(){
  showScreen('guruLogin');
}

function guruSubmit(){
  let pass = document.getElementById('guruPass').value.trim();
  guruError.style.display = "none";

  if(!pass){
    guruError.innerText = "Masukkan password!";
    guruError.style.display = "block";
    return;
  }

  if(pass === "040698"){ 
    showScreen('menuAdmin');
  } else {
    guruError.innerText = "Password salah!";
    guruError.style.display = "block";
  }
}

function logoutGuru(){
  showScreen('login');
}

/* ================= DATA KHODAM ================= */
const KHODAM_LIST = [
  "Maung Hitam","Maung Putih","Aura Hitam","Aura Putih",
  "Kadal","Pariuk","Panci","Oncom","Tempe","Tahu",
  "Pemalas","Rajin Ibadah","Soleh","Solehah",
  "Jomblo Hepy","Jomblo Gak Punya Uang","Cacing","Kekenceng",
  "Suka Molor","Suka Judi","Suka Maling","Suka Keluyuran Tengah Malam"
];

let khodamSave = JSON.parse(localStorage.getItem("khodamPai") || "{}");

/* ================= CEK KHODAM + AUTO TTS ================= */
function openKhodam(){
  showScreen('khodamScreen');
}

function generateKhodam(){
  let name = document.getElementById("khodamName").value.trim();
  if(!name) return alert("Masukkan nama dulu!");

  if(!khodamSave[name]){
    let rnd = KHODAM_LIST[Math.floor(Math.random()*KHODAM_LIST.length)];
    khodamSave[name] = rnd;
    localStorage.setItem("khodamPai", JSON.stringify(khodamSave));
  }

  let hasil = khodamSave[name];

  document.getElementById("khodamResult").innerHTML =
  `üîÆ <b>Nama:</b> ${name}<br><br>
   üêØ <b>Khodam kamu adalah:</b><br>
   <span style="font-size:1.3rem;color:var(--primary);font-weight:bold;">
   ${hasil}
   </span><br><br>
   <i>(hiburan saja üòä)</i>`;

  speakKhodam(name, hasil);
}

function speakKhodam(name, hasil){
  let text = `${name}, Khodam kamu adalah, ${hasil}.`;
  let u = new SpeechSynthesisUtterance(text);
  u.lang = "id-ID";
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}
/* ================= INPUT NAMA ================= */
function simpanNama(){
  let nama=namaInput.value.trim();
  let k=kelasInput.value;
  if(!nama||!k) return alert("Lengkapi!");
  if(!siswa[k]) siswa[k]=[];
  if(!siswa[k].includes(nama)) siswa[k].push(nama);
  if(!absensi[k]) absensi[k]={};
  if(!absensi[k][nama]) absensi[k][nama]=Array(30).fill("");
  saveAll();
  loadListNama();
  namaInput.value="";kelasInput.value="";
}

function loadListNama(){
  listNamaBox.innerHTML="";
  for(let k in siswa){
    listNamaBox.innerHTML+=`<b>${k}</b><br>`;
    siswa[k].forEach(n=>listNamaBox.innerHTML+=`‚Ä¢ ${n}<br>`);
    listNamaBox.innerHTML+="<br>";
  }
}

/* ================= ABSENSI ================= */
function loadAbsensi(){
  if(!Object.keys(siswa).length) return alert("Belum ada siswa!");
  hariSpan.innerText=hari;
  absenWrapper.innerHTML="";
  for(let k in siswa){
    absenWrapper.innerHTML+=`<h3 style="color:var(--primary);">${k}</h3>`;
    siswa[k].forEach(n=>{
      absenWrapper.innerHTML+=`
      <div class="statusRow">
        ${n}
        <div>
          <button class="absenBtn h" onclick="setStat('${k}','${n}','H')">H</button>
          <button class="absenBtn i" onclick="setStat('${k}','${n}','I')">I</button>
          <button class="absenBtn s" onclick="setStat('${k}','${n}','S')">S</button>
          <button class="absenBtn a" onclick="setStat('${k}','${n}','A')">A</button>
        </div>
        ${absensi[k][n][hari-1]||'-'}
      </div>`;
    });
  }
  showScreen('absenScreen');
}

function setStat(k,n,s){absensi[k][n][hari-1]=s;saveAll();loadAbsensi();}
function hariBerikutnya(){if(hari<30){hari++;saveAll();loadAbsensi();}else alert("30 hari selesai!");}

/* ================= REKAP ABSENSI ================= */
function loadRekapAbsensi(){
  rekapAbsenWrapper.innerHTML="";
  for(let k in siswa){
    let html=`<h3 style="color:var(--primary);">${k}</h3>
    <div style="overflow-x:auto;"><table><thead><tr><th>Nama</th>`;
    for(let i=1;i<=30;i++) html+=`<th>${i}</th>`;
    html+=`</tr></thead><tbody>`;
    siswa[k].forEach(n=>{
      html+=`<tr><td>${n}</td>`;
      absensi[k][n].forEach(v=>html+=`<td>${v||'-'}</td>`);
      html+=`</tr>`;
    });
    html+=`</tbody></table></div>`;
    rekapAbsenWrapper.innerHTML+=html;
  }
  showScreen('rekapAbsenScreen');
}

/* ================= REKAP NILAI ================= */
function loadRekapNilai(){
  rekapNilaiWrapper.innerHTML="";
  ["3A","3B","4A","4B"].forEach(k=>{
    let f=nilai.filter(x=>x.class===k);
    if(!f.length)return;
    f.sort((a,b)=>b.score-a.score);
    let high=f[0].score;
    let html=`<h3 style="color:var(--primary);">${k} ‚Äî Highscore: ${high}</h3>
    <div style="overflow-x:auto;"><table><thead><tr>
    <th>No</th><th>Nama</th><th>Nilai</th><th>Waktu</th></tr></thead><tbody>`;
    f.forEach((x,i)=>{
      let cls=x.score===high?'tr-gold':x.score>=80?'tr-green':x.score>=60?'tr-orange':'tr-red';
      html+=`<tr class="${cls}"><td>${i+1}</td><td>${x.name}</td><td>${x.score}</td><td>${x.time}</td></tr>`;
    });
    html+=`</tbody></table></div>`;
    rekapNilaiWrapper.innerHTML+=html;
  });
  showScreen('rekapNilaiScreen');
}

/* ================= EXPORT EXCEL ================= */
function exportNilai(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(nilai);
  XLSX.utils.book_append_sheet(wb,ws,"Nilai");
  XLSX.writeFile(wb,"rekap_nilai.xlsx");
}
function exportAbsensi(){
  const wb=XLSX.utils.book_new();
  let data=[];
  for(let k in absensi){
    for(let n in absensi[k]){
      data.push({kelas:k,nama:n,status:absensi[k][n].join(",")});
    }
  }
  const ws=XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb,ws,"Absensi");
  XLSX.writeFile(wb,"rekap_absen.xlsx");
}

/* ================= REPEAT MODE ================= */
function toggleRepeat(){
  repeatMode=!repeatMode;
  localStorage.setItem("repeatMode",repeatMode);
  updateRepeatLabel();
}
function updateRepeatLabel(){repeatLabel.innerText=repeatMode?"ON":"OFF";}
updateRepeatLabel();

/* ================= AUDIO ================= */
function toggleMusic(){
  const bg=document.getElementById('bgm');
  if(bg.paused){
    bg.play().catch(err=>console.log(err));
  } else {
    bg.pause();
  }
}
function unlockAudio(){
  const bg=document.getElementById('bgm');
  bg.play().then(()=> bg.pause()).catch(()=>{});
}
document.addEventListener('touchstart', unlockAudio, { once:true });
document.addEventListener('click', unlockAudio, { once:true });

/* ================= UTIL ================= */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    let j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function saveAll(){
  localStorage.setItem("siswaPai",JSON.stringify(siswa));
  localStorage.setItem("absensiPai",JSON.stringify(absensi));
  localStorage.setItem("nilaiPai",JSON.stringify(nilai));
  localStorage.setItem("hariPai",hari);
}
function restart(){location.reload();}
function resetSemua(){
  if(confirm("Reset semua data?")){
    localStorage.clear();
    siswa={};absensi={};nilai=[];hari=1;
    alert("Sudah direset!");
    restart();
  }
}
</script>

<!-- AUDIO PLAYER -->
<audio id="bgm" src="ala.mp3" preload="auto" controls style="display:none;"></audio>

</div>
</body>
</html>
